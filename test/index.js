if (typeof window !== 'undefined') {
  // const quickjs = require('../build/emscripten/qjs_binding.js')
  // const emnapi = require('@emnapi/runtime')
  
  quickjs().then(Module => {
    const binding = Module.emnapiInit({ context: emnapi.getDefaultContext() })
    main(binding)
  })
} else {
  main(require('..'))
}

/**
 * @param {import('..')} binding 
 */
function main (binding) {
  const { Runtime, Context, std } = binding
  console.log(binding)
  const rt = new Runtime()
  console.log('rt:', rt.data())
  std.initHandlers(rt)
  const ctx = new Context(rt)
  console.log('ctx:', ctx.data())
  const promise = ctx.eval("Promise.resolve(Object.keys(globalThis)).then(console.log)")
  promise.then((ret) => {
    console.log(ret)
  })
  std.loop(ctx)
  console.log(Date.now())
  console.log(ctx.eval('Symbol("local.symbol")'))
  std.evalBinary(ctx, new Uint8Array([
    0x02, 0x04, 0x0e, 0x63, 0x6f, 0x6e, 0x73, 0x6f,
    0x6c, 0x65, 0x06, 0x6c, 0x6f, 0x67, 0x12, 0x68,
    0x65, 0x6c, 0x6c, 0x6f, 0x20, 0x71, 0x6a, 0x73,
    0x10, 0x69, 0x6e, 0x64, 0x65, 0x78, 0x2e, 0x6a,
    0x73, 0x0e, 0x00, 0x06, 0x00, 0xa0, 0x01, 0x00,
    0x01, 0x00, 0x03, 0x00, 0x00, 0x14, 0x01, 0xa2,
    0x01, 0x00, 0x00, 0x00, 0x38, 0xe1, 0x00, 0x00,
    0x00, 0x42, 0xe2, 0x00, 0x00, 0x00, 0x04, 0xe3,
    0x00, 0x00, 0x00, 0x24, 0x01, 0x00, 0xcd, 0x28,
    0xc8, 0x03, 0x01, 0x00
  ]))
  ctx.dispose()
  rt.dispose()
}
